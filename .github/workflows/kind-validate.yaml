name: Kind Cluster Validation

on:
  workflow_call:
    inputs:
      config-path:
        description: 'Path to Kind cluster config file'
        type: string
        required: true
      kind-version:
        description: 'Kind version for validation'
        type: string
        required: false
        default: '0.21.0'
      validate-schema:
        description: 'Validate against Kind config schema (dry-run)'
        type: boolean
        required: false
        default: true
    outputs:
      valid:
        description: 'Whether the config is valid'
        value: ${{ jobs.kind-validate.outputs.valid }}
      node-count:
        description: 'Number of nodes in configuration'
        value: ${{ jobs.kind-validate.outputs.node-count }}

jobs:
  kind-validate:
    name: Validate Kind Config
    runs-on: ubuntu-latest

    outputs:
      valid: ${{ steps.validate.outputs.valid }}
      node-count: ${{ steps.validate.outputs.node_count }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Kind
        uses: helm/kind-action@v1
        with:
          install_only: true
          version: v${{ inputs.kind-version }}

      - name: Validate Kind Configuration
        id: validate
        run: |
          CONFIG_FILE="${{ inputs.config-path }}"
          VALID="true"
          NODE_COUNT=0

          echo "=========================================="
          echo "Validating Kind Configuration"
          echo "=========================================="
          echo "Config file: ${CONFIG_FILE}"
          echo ""

          # Check file exists
          if [[ ! -f "${CONFIG_FILE}" ]]; then
            echo "::error::Config file not found: ${CONFIG_FILE}"
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "node_count=0" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Display config
          echo "Configuration:"
          echo "----------------------------------------"
          cat "${CONFIG_FILE}"
          echo ""
          echo "----------------------------------------"

          # Validate YAML syntax using Python (always available)
          echo ""
          echo "Step 1: Checking YAML syntax..."
          if python3 -c "import yaml; yaml.safe_load(open('${CONFIG_FILE}'))"; then
            echo "YAML syntax is valid"
          else
            echo "::error::Invalid YAML syntax"
            VALID="false"
          fi

          # Check Kind config structure using Python
          echo ""
          echo "Step 2: Checking Kind config structure..."
          python3 << EOF
import yaml
import sys

with open('${CONFIG_FILE}') as f:
    config = yaml.safe_load(f)

kind_type = config.get('kind', '')
api_version = config.get('apiVersion', '')

print(f"  kind: {kind_type}")
print(f"  apiVersion: {api_version}")

errors = []
if kind_type != 'Cluster':
    errors.append(f"Invalid kind: expected 'Cluster', got '{kind_type}'")

if not api_version.startswith('kind.x-k8s.io/'):
    errors.append(f"Invalid apiVersion: {api_version}")

nodes = config.get('nodes', [])
node_count = len(nodes) if nodes else 1
print(f"  nodes: {node_count}")

# Write node count to file for bash to read
with open('/tmp/node_count', 'w') as f:
    f.write(str(node_count))

if errors:
    for e in errors:
        print(f"::error::{e}")
    sys.exit(1)
EOF

          if [[ $? -ne 0 ]]; then
            VALID="false"
          fi

          NODE_COUNT=$(cat /tmp/node_count 2>/dev/null || echo "1")

          # Dry run validation with Kind
          if [[ "${{ inputs.validate-schema }}" == "true" && "${VALID}" == "true" ]]; then
            echo ""
            echo "Step 3: Running Kind dry-run validation..."
            if kind create cluster --config "${CONFIG_FILE}" --name validation-test --dry-run 2>&1; then
              echo "Kind dry-run validation passed"
            else
              echo "::error::Kind dry-run validation failed"
              VALID="false"
            fi
          fi

          echo ""
          echo "=========================================="
          echo "Validation Result: ${VALID}"
          echo "=========================================="

          echo "valid=${VALID}" >> $GITHUB_OUTPUT
          echo "node_count=${NODE_COUNT}" >> $GITHUB_OUTPUT

          if [[ "${VALID}" != "true" ]]; then
            exit 1
          fi

      - name: Add Summary
        if: always()
        run: |
          echo "## Kind Configuration Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Config File | \`${{ inputs.config-path }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Valid | ${{ steps.validate.outputs.valid }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node Count | ${{ steps.validate.outputs.node_count }} |" >> $GITHUB_STEP_SUMMARY
