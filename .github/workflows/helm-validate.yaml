name: Helm Chart Validation

on:
  workflow_call:
    inputs:
      chart-path:
        description: 'Path to Helm chart directory'
        type: string
        required: true
      values-file:
        description: 'Additional values file for rendering'
        type: string
        required: false
        default: ''
      kube-version:
        description: 'Kubernetes version for validation'
        type: string
        required: false
        default: '1.29.0'
      strict:
        description: 'Enable strict mode (warnings cause failure)'
        type: boolean
        required: false
        default: false
      helm-version:
        description: 'Helm version to use'
        type: string
        required: false
        default: '3.14.0'
      upload-manifests:
        description: 'Upload rendered manifests as artifact'
        type: boolean
        required: false
        default: true
    outputs:
      lint-passed:
        description: 'Whether helm lint passed'
        value: ${{ jobs.helm-validate.outputs.lint-passed }}
      template-passed:
        description: 'Whether helm template passed'
        value: ${{ jobs.helm-validate.outputs.template-passed }}

jobs:
  helm-validate:
    name: Validate Helm Chart
    runs-on: ubuntu-latest

    outputs:
      lint-passed: ${{ steps.lint.outputs.passed }}
      template-passed: ${{ steps.template.outputs.passed }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm-version }}

      - name: Add Helm Repositories (if needed)
        run: |
          if [[ -f "${{ inputs.chart-path }}/Chart.lock" ]]; then
            echo "Building Helm dependencies..."
            helm dependency build "${{ inputs.chart-path }}" || true
          fi

      - name: Helm Lint
        id: lint
        run: |
          echo "Running helm lint..."
          LINT_ARGS="${{ inputs.chart-path }}"

          if [[ -n "${{ inputs.values-file }}" ]]; then
            LINT_ARGS="${LINT_ARGS} -f ${{ inputs.values-file }}"
          fi

          if [[ "${{ inputs.strict }}" == "true" ]]; then
            LINT_ARGS="${LINT_ARGS} --strict"
          fi

          if helm lint ${LINT_ARGS}; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "Helm lint passed"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "Helm lint failed"
            exit 1
          fi

      - name: Helm Template
        id: template
        run: |
          echo "Running helm template..."
          mkdir -p ./rendered-manifests

          TEMPLATE_ARGS="test-release ${{ inputs.chart-path }}"

          if [[ -n "${{ inputs.values-file }}" ]]; then
            TEMPLATE_ARGS="${TEMPLATE_ARGS} -f ${{ inputs.values-file }}"
          fi

          if [[ -n "${{ inputs.kube-version }}" ]]; then
            TEMPLATE_ARGS="${TEMPLATE_ARGS} --kube-version ${{ inputs.kube-version }}"
          fi

          if helm template ${TEMPLATE_ARGS} > ./rendered-manifests/manifests.yaml; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "Helm template passed"
            RESOURCE_COUNT=$(grep -c "^kind:" ./rendered-manifests/manifests.yaml || echo 0)
            echo "Rendered ${RESOURCE_COUNT} Kubernetes resources"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "Helm template failed"
            exit 1
          fi

      - name: Upload Rendered Manifests
        if: ${{ inputs.upload-manifests && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: helm-rendered-manifests
          path: ./rendered-manifests/
          retention-days: 7

      - name: Add Summary
        if: always()
        run: |
          echo "## Helm Chart Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ steps.lint.outputs.passed == 'true' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Template | ${{ steps.template.outputs.passed == 'true' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Path:** \`${{ inputs.chart-path }}\`" >> $GITHUB_STEP_SUMMARY
